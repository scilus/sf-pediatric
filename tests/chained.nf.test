nextflow_pipeline {

    options "-stub-run"

    name "Test sf-pediatric all profiles chained"
    script "../main.nf"

    test("Segmentation + connectomics profiles - should run successfully") {

        when {
            params {

                params.input = "$projectDir/tests/data/bids/"
                params.participant_label = ["sub-test1", "sub-test3", "sub-test4"]
                params.input_deriv = "$projectDir/tests/data/derivatives/"
                params.outdir = "$outputDir"

                params.connectomics = true
                params.segmentation = true
                params.fs_license = "https://www.dropbox.com/scl/fi/0s8lp6lydyd0rxawxb4jm/license.txt?rlkey=hz54oc0d4sor69avqphtrjvgn&st=9e0yij97&dl=0"

            }
        }

        then {
            // stable name: All files + folders in ${params.outdir}/ with a stable name.
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore:  ['pipeline_info/*.{html,json,txt}'])
            // All fastsurfer output.
            def fastsurfer_output = getAllFilesFromDir("$outputDir/../freesurfer/", relative: true, includeDir: true)
            def mcribs_output = getAllFilesFromDir("$outputDir/../mcribs-2.1.0/", relative: true, includeDir: true)
            assertAll {
                assert workflow.success
                assert snapshot(
                    // Number of successfully completed tasks
                    workflow.trace.succeeded().size(),
                    // Remove the nextflow version from the versions.yml because we test it using different nextflow versions.
                    removeNextflowVersion("$outputDir/pipeline_info/sf-pediatric_software_mqc_versions.yml"),
                    // All stable name.
                    stable_name,
                    // All fastsurfer output.
                    fastsurfer_output
                ).match()
            }
        }
    }

    test("Connectomics + tracking profiles - should run successfully") {

        when {
            params {

                params.input = "$projectDir/tests/data/bids/"
                params.participant_label = ["sub-test1", "sub-test2", "sub-test4"]
                params.input_deriv = "$projectDir/tests/data/derivatives/"
                params.outdir = "$outputDir"

                params.connectomics = true
                params.tracking = true

            }
        }

        then {
            // stable name: All files + folders in ${params.outdir}/ with a stable name.
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore:  ['pipeline_info/*.{html,json,txt}'])
            assertAll {
                assert workflow.success
                assert snapshot(
                    // Number of successfully completed tasks
                    workflow.trace.succeeded().size(),
                    // Remove the nextflow version from the versions.yml because we test it using different nextflow versions.
                    removeNextflowVersion("$outputDir/pipeline_info/sf-pediatric_software_mqc_versions.yml"),
                    // All stable name.
                    stable_name
                ).match()
            }
        }
    }

    test("Connectomics + tracking + segmentation profiles - should run successfully") {

        when {
            params {

                params.input = "$projectDir/tests/data/bids/"
                params.participant_label = ["sub-test1", "sub-test2", "sub-test3"]
                params.outdir = "$outputDir"

                params.template = "MNIInfant"
                params.templateflow_res = 1
                params.templateflow_cohort = 1

                params.connectomics = true
                params.tracking = true
                params.segmentation = true

                params.fs_license = "https://www.dropbox.com/scl/fi/0s8lp6lydyd0rxawxb4jm/license.txt?rlkey=hz54oc0d4sor69avqphtrjvgn&st=9e0yij97&dl=0"
            }
        }

        then {
            // stable name: All files + folders in ${params.outdir}/ with a stable name.
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore:  ['pipeline_info/*.{html,json,txt}'])
            // All fastsurfer output.
            def fastsurfer_output = getAllFilesFromDir("$outputDir/../freesurfer/", relative: true, includeDir: true)
            def mcribs_output = getAllFilesFromDir("$outputDir/../mcribs-2.1.0/", relative: true, includeDir: true)
            assertAll {
                assert workflow.success
                assert snapshot(
                    // Number of successfully completed tasks
                    workflow.trace.succeeded().size(),
                    // Remove the nextflow version from the versions.yml because we test it using different nextflow versions.
                    removeNextflowVersion("$outputDir/pipeline_info/sf-pediatric_software_mqc_versions.yml"),
                    // All stable name.
                    stable_name,
                    // All fastsurfer output.
                    fastsurfer_output,
                    mcribs_output
                ).match()
            }
        }
    }

    test("Bundling + tracking profiles - should run successfully") {

        when {
            params {

                params.input = "$projectDir/tests/data/bids/"
                params.participant_label = ["sub-test1", "sub-test2", "sub-test4"]
                params.outdir = "$outputDir"

                params.bundling = true
                params.tracking = true

            }
        }

        then {
            // stable name: All files + folders in ${params.outdir}/ with a stable name.
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore:  ['pipeline_info/*.{html,json,txt}'])
            assertAll {
                assert workflow.success
                assert snapshot(
                    // Number of successfully completed tasks
                    workflow.trace.succeeded().size(),
                    // Remove the nextflow version from the versions.yml because we test it using different nextflow versions.
                    removeNextflowVersion("$outputDir/pipeline_info/sf-pediatric_software_mqc_versions.yml"),
                    // All stable name.
                    stable_name
                ).match()
            }
        }
    }
}
